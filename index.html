<script>
    // *** משתנים גלובליים ***
    let nextOffset = null;
    let isLoading = false;
    let editingRecordId = null;
    let allRecords = []; // המערך הראשי שמכיל את כל הרשומות שנטענו עד כה
    let isFiltering = false; // דגל שבודק אם יש סינון פעיל

    // *** פונקציות עזר ***

    // ממיר מערך של רשומות Airtable לאובייקט שטוח יותר
    function formatRecords(records) {
        return records.map(record => ({
            id: record.id,
            fields: record.fields
        }));
    }

    // *** פונקציית טעינה ***

    async function fetchRecords(reset = false) {
        // מונע קריאות כפולות או טעינה כשיש סינון פעיל
        if (isLoading || (!reset && nextOffset === null && allRecords.length > 0)) return;
        
        // **תיקון קריטי 1: מניעת טעינת דפים נוספים בזמן סינון**
        if (isFiltering && !reset) {
            document.getElementById('loadMoreContainer').style.display = 'none';
            return;
        }

        isLoading = true;
        document.getElementById('loadingIndicator').style.display = 'block';

        if (reset) {
            allRecords = [];
            nextOffset = null;
            // איפוס גם בממשק
            document.getElementById('tableBody').innerHTML = ''; 
        }

        let url = '/.netlify/functions/airtable';
        if (nextOffset && !reset) {
            url += `?offset=${nextOffset}`;
        }
        
        try {
            const response = await fetch(url);
            const data = await response.json();
            
            if (!response.ok) {
                throw new Error(data.error || 'שגיאה כללית בטעינת נתונים');
            }

            const newRecords = formatRecords(data.records);
            
            // **תיקון קריטי 2: שמירת הרשומות המלאות**
            allRecords.push(...newRecords);
            nextOffset = data.offset || null;

            // הצגת הרשומות החדשות
            displayRecords(newRecords, reset);

            // עדכון כפתור "טען עוד"
            if (nextOffset) {
                document.getElementById('loadMoreContainer').style.display = 'block';
            } else {
                document.getElementById('loadMoreContainer').style.display = 'none';
            }

        } catch (error) {
            console.error("שגיאה בטעינת נתונים מ-Airtable:", error);
            document.getElementById('loadingIndicator').innerText = 'שגיאה בטעינת נתונים.';
        } finally {
            isLoading = false;
            if (document.getElementById('loadingIndicator').innerText === 'טוען...') {
                 document.getElementById('loadingIndicator').style.display = 'none';
            }
        }
    }

    // *** פונקציית הצגת נתונים ***

    function displayRecords(recordsToDisplay, reset) {
        const tbody = document.getElementById('tableBody');

        if (reset) {
            tbody.innerHTML = '';
        }
        
        if (allRecords.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7">לא נמצאו רשומות.</td></tr>';
            return;
        }

        recordsToDisplay.forEach(record => {
            const row = tbody.insertRow();
            row.setAttribute('data-id', record.id);
            
            // יצירת התאים (מותאם לקוד ה-HTML ששלחת)
            // ודא ששמות השדות בתוך record.fields תואמים בדיוק לשמות השדות ב-Airtable!
            row.innerHTML = `
                <td>${record.fields['#'] || ''}</td>
                <td>${record.fields['שם המונצח'] || ''}</td>
                <td>${record.fields['שם משפחה מונצח'] || ''}</td>
                <td>${record.fields['טלפון'] || ''}</td>
                <td>${record.fields['הערות'] || ''}</td>
                <td class="text-center">
                    <button onclick="editRecord('${record.id}')" class="btn btn-warning btn-sm">ערוך</button>
                    <button onclick="deleteRecord('${record.id}')" class="btn btn-danger btn-sm">מחק</button>
                </td>
            `;
        });
    }

    // *** פונקציות עריכה ומחיקה ***

    function editRecord(id) {
        const record = allRecords.find(r => r.id === id);
        if (record) {
            editingRecordId = id;
            document.getElementById('modalTitle').innerText = 'עריכת רשומה';
            document.getElementById('recordId').value = record.fields['#'] || '';
            document.getElementById('recordName').value = record.fields['שם המונצח'] || '';
            document.getElementById('recordFamilyName').value = record.fields['שם משפחה מונצח'] || '';
            document.getElementById('recordPhone').value = record.fields['טלפון'] || '';
            document.getElementById('recordNotes').value = record.fields['הערות'] || '';
            openModal();
        }
    }

    async function deleteRecord(id) {
        if (!confirm('האם אתה בטוח שברצונך למחוק רשומה זו?')) return;

        try {
            const response = await fetch(`/.netlify/functions/airtable?id=${id}`, {
                method: 'DELETE',
            });
            if (!response.ok) throw new Error('שגיאה במחיקת הרשומה');

            // הסר את הרשומה מהמערך המקומי
            allRecords = allRecords.filter(r => r.id !== id);
            
            // רענן את התצוגה (reset=true כדי לנקות את הטבלה ולהציג את כל הנתונים המעודכנים)
            // *רצוי פשוט למחוק את השורה מה-DOM לביצוע מהיר יותר, אבל טעינה מחדש מבטיחה סנכרון*
            await fetchRecords(true); 

        } catch (error) {
            alert(`שגיאה במחיקה: ${error.message}`);
        }
    }

    // *** לוגיקת ממשק משתמש (Modal, Submit, Filter) ***

    function openModal() {
        document.getElementById('recordModal').classList.add('show');
        document.body.style.overflow = 'hidden';
    }

    function closeModal() {
        document.getElementById('recordModal').classList.remove('show');
        document.body.style.overflow = 'auto';
        document.getElementById('recordForm').reset();
        // **תיקון קריטי 3: איפוס ה-ID לאחר סגירת המודל**
        editingRecordId = null; 
    }

    document.getElementById('addNewRecord').addEventListener('click', () => {
        document.getElementById('modalTitle').innerText = 'הוספת רשומה חדשה';
        editingRecordId = null; 
        document.getElementById('recordForm').reset();
        openModal();
    });

    document.getElementById('recordForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const recordId = document.getElementById('recordId').value;
        const name = document.getElementById('recordName').value;
        const familyName = document.getElementById('recordFamilyName').value;
        const phone = document.getElementById('recordPhone').value;
        const notes = document.getElementById('recordNotes').value;

        const fields = {
            '#': recordId,
            'שם המונצח': name,
            'שם משפחה מונצח': familyName,
            'טלפון': phone,
            'הערות': notes,
        };

        const method = editingRecordId ? 'PATCH' : 'POST';
        let url = '/.netlify/functions/airtable';
        if (editingRecordId) {
            url += `?id=${editingRecordId}`;
        }
        
        try {
            const response = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ fields }),
            });

            if (!response.ok) throw new Error('שגיאה בשמירת הרשומה');

            closeModal();
            // **תיקון קריטי 4: איפוס ה-ID לאחר שמירה מוצלחת**
            editingRecordId = null; 
            
            // טען מחדש את כל הנתונים מההתחלה כדי לקבל את הרשומה החדשה/המעודכנת
            await fetchRecords(true);
        } catch (error) {
            alert(`שגיאה בשמירה: ${error.message}`);
        }
    });

    // *** לוגיקת סינון ***
    
    function filterRecords() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        
        if (searchTerm.length > 0) {
            isFiltering = true;
            document.getElementById('loadMoreContainer').style.display = 'none';

            const filtered = allRecords.filter(record => {
                const name = record.fields['שם המונצח'] || '';
                const familyName = record.fields['שם משפחה מונצח'] || '';
                const phone = record.fields['טלפון'] || '';
                
                return name.toLowerCase().includes(searchTerm) ||
                       familyName.toLowerCase().includes(searchTerm) ||
                       phone.includes(searchTerm);
            });
            
            // הצגת הרשומות המסוננות (reset=true מנקה את הטבלה לפני ההצגה)
            displayRecords(filtered, true);
        } else {
            // **תיקון קריטי 5: ביטול סינון והצגת כל הרשומות שנטענו**
            isFiltering = false;
            
            // הצגת כל רשומות המאסטר שנטענו עד כה
            displayRecords(allRecords, true); 
            
            // הצג את כפתור "טען עוד" רק אם יש Offset נוסף
            if (nextOffset) {
                document.getElementById('loadMoreContainer').style.display = 'block';
            }
        }
    }

    // *** אתחול ***

    document.addEventListener('DOMContentLoaded', () => {
        // טען את הדף הראשון עם טעינה ראשונית (reset=true)
        fetchRecords(true); 

        // קישור כפתור "טען עוד"
        document.getElementById('loadMore').addEventListener('click', () => {
            fetchRecords(false); // טען את הדף הבא
        });

        // קישור שדה החיפוש
        document.getElementById('searchInput').addEventListener('input', filterRecords);
    });
</script>
